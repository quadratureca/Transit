<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html lang="en">
<head>
    <title>Transit App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
          integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
          crossorigin="" />
    <link href="Content/LeafletMap.css" rel="stylesheet" />
</head>
<body>
    <div id='map' />

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
            integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
            crossorigin="">
    </script>

    <!--<script src="Content/App.min.js"></script>-->

    <script type="text/javascript">
        let markerEntity;
        let markerEntities = [];
        let timeoutHandle = null;
        let position;

        function initialise() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(getPosition, errorPosition);
            } else {
                position = [43.55954, -79.72672];
                createMap();
            }
        }

        function getPosition(location) {
            position = [location.coords.latitude, location.coords.longitude];
            createMap();
        }

        function errorPosition() {
            position = [43.55954, -79.72672];
            createMap();
        }

        function createMap() {
            map = L.map('map', { attributionControl: false, zoomControl: true }).setView(position, 14);
            L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            }).addTo(map);

            map.addEventListener('moveend', function (event) {
                if (timeoutHandle != null) {
                    clearTimeout(timeoutHandle);
                }
                timeoutHandle = setTimeout(getUpdateData, 100);
            });

            markerEntities.length = 0;
            timeoutHandle = setTimeout(getUpdateData, 100);
        }

        function createBus(route, bearing, bearingValid, routeColor, routeTextColor) {
            var canvas, ctx;

            canvas = document.createElement("canvas");
            canvas.width = 48;
            canvas.height = 48;

            ctx = canvas.getContext("2d");

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.beginPath();
            ctx.arc(24, 24, 16, 0, Math.PI * 2, 0);
            ctx.fillStyle = '#' + routeColor;
            ctx.fill();

            ctx.font = "bold 12px Arial";
            let text = ctx.measureText(route);
            let x = (48 - text.width) / 2;
            let height = text.actualBoundingBoxAscent + text.actualBoundingBoxDescent;
            let y = (48 + height) / 2;

            ctx.fillStyle = '#' + routeTextColor;
            ctx.fillText(route, x, y);

            if (bearingValid == true) {
                ctx.fillStyle = '#' + routeColor;
                ctx.beginPath();
                switch (bearing) {
                    case 0:
                        ctx.moveTo(24, 0);
                        ctx.lineTo(36, 9);
                        ctx.lineTo(24, 4);
                        ctx.lineTo(12, 9);
                        break;
                    case 45:
                        ctx.moveTo(41, 7);
                        ctx.lineTo(43, 22);
                        ctx.lineTo(38, 10);
                        ctx.lineTo(26, 5);
                        break;
                    case 90:
                        ctx.moveTo(47, 23);
                        ctx.lineTo(39, 36);
                        ctx.lineTo(43, 24);
                        ctx.lineTo(39, 12);
                        break;
                    case 135:
                        ctx.moveTo(41, 41);
                        ctx.lineTo(26, 43);
                        ctx.lineTo(38, 38);
                        ctx.lineTo(43, 26);
                        break;
                    case 180:
                        ctx.moveTo(24, 47);
                        ctx.lineTo(12, 39);
                        ctx.lineTo(24, 43);
                        ctx.lineTo(36, 39);
                        break;
                    case 225:
                        ctx.moveTo(7, 41);
                        ctx.lineTo(5, 26);
                        ctx.lineTo(10, 38);
                        ctx.lineTo(22, 43);
                        break;
                    case 270:
                        ctx.moveTo(0, 24);
                        ctx.lineTo(9, 12);
                        ctx.lineTo(4, 24);
                        ctx.lineTo(9, 36);
                        break;
                    case 315:
                        ctx.moveTo(7, 7);
                        ctx.lineTo(22, 5);
                        ctx.lineTo(10, 10);
                        ctx.lineTo(5, 22);
                        break;
                    default:
                        break;
                }
                ctx.closePath();
                ctx.fill();
            }

            return canvas.toDataURL();
        }

        async function getTransitData(south, west, north, east) {
            let bounds = { "South": south, "West": west, "North": north, "East": east };

            var apiUrl = 'https://transit.tripsystem.net/entities?bounds=' + JSON.stringify(bounds);

            const response = await fetch(apiUrl);
            const entities = await response.json();
            return entities;
        }

        function getUpdateData() {
            timeoutHandle = null;
            let bounds = map.getBounds();

            getTransitData(bounds._southWest.lat, bounds._southWest.lng, bounds._northEast.lat, bounds._northEast.lng).then(entities => {
                update(entities);
            });
        }

        function update(entities) {
            let meIndex;
            let incomingEntities = [];
            debugger;
            entities.forEach(function (entity, index) {
                incomingEntities.push(entity);
            });
            entities.forEach(function (entity, index) {
                if (markerEntities.length == 0) {
                    meIndex = -1;
                } else {
                    meIndex = markerEntities.findIndex(mE => mE.Entity.vehicleId == entity.vehicleId);
                }
                if (meIndex == -1) {
                    // Create marker, add marker and entity to markerEntities
                    let marker = L.marker([entity.latitude, entity.longitude],
                        {
                            icon: L.icon({
                                iconUrl: createBus(entity.routeShortName, entity.bearing, entity.bearingValid,
                                                   entity.routeColor, entity.routeTextColor),
                                iconSize: [48, 48],
                                iconAnchor: [24, 24]
                            }),
                            entity: JSON.stringify(entity)
                        }).addTo(map).bindPopup(entity.routeLongName);
                    markerEntity = { marker: marker, Entity: entity };
                    markerEntities.push(markerEntity);
                } else {
                    // Check if lat and long are unchanged.
                    // If yes then update markerEntities
                    // if no then move marker and update markerEntities
                    let currentMe = markerEntities[meIndex];
                    if (currentMe.Entity.bearing == entity.bearing &&
                        currentMe.Entity.longitude == entity.longitude &&
                        currentMe.Entity.latitude == entity.latitude) {
                        // Vehicle has not moved - nothing to do except update entity
                        markerEntities[meIndex].Entity = entity;
                    } else if (currentMe.Entity.bearing !== entity.bearing) {
                        // Vehicle has turned - delete and recreate
                        //currentMe.marker.setMap(null);
                        map.removeLayer(currentMe.marker);
                        // Create marker, add marker and entity to markerEntities
                        let marker = L.marker([entity.latitude, entity.longitude],
                            {
                                icon: L.icon({
                                    iconUrl: createBus(entity.routeShortName, entity.bearing, entity.bearingValid,
                                        entity.routeColor, entity.routeTextColor),
                                    iconSize: [48, 48],
                                    iconAnchor: [24, 24]
                                }),
                                entity: JSON.stringify(entity)
                            }).addTo(map).bindPopup(entity.routeLongName);
                        markerEntities[meIndex] = { marker: marker, Entity: entity };
                    } else if (currentMe.Entity.latitude !== entity.latitude ||
                        currentMe.Entity.longitude !== entity.longitude) {
                        // Vehicle has moved but not turned
                        currentMe.marker.setLatLng([entity.latitude, entity.longitude])
                        markerEntities[meIndex].Entity = entity;
                    }
                }
            });

            // Now check for orphaned markerEntities and remove the marker
            for (var i = markerEntities.length - 1; i >= 0; i--) {
                let ieIndex = incomingEntities.findIndex(iE => iE.vehicleId == markerEntities[i].Entity.vehicleId);
                if (ieIndex == -1) {
                    map.removeLayer(markerEntities[i].marker);
                    markerEntities.splice(i, 1);
                }
            }

            timeoutHandle = setTimeout(getUpdateData, 15000);
        }

    </script>



    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function (event) {
            initialise();
        });

    </script>
</body>
</html>